<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>therochord</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="images/favicon.png" />
    <!-- Using esm.sh for module loading -->
    <script type="importmap">
      {
        "imports": {
          "bg-tone": "https://esm.sh/tone@14.7.77",
          "bg-tonal": "https://esm.sh/@tonaljs/tonal@4.10.0",
          "bg-voice-leading": "https://esm.sh/@tonaljs/voice-leading@4.10.0",
          "bg-voicing": "https://esm.sh/@tonaljs/voicing@4.10.0"
        }
      }
    </script>
  </head>
  <body>
    <div id="chord-tint"></div>
    <div id="background-fx"></div>
    <div id="app">
      <header>
        <div class="title-row">
          <h1>therochord</h1>
          <button id="help-btn" aria-label="Help">?</button>
        </div>
        <p></p>
      </header>

      <div class="controls">
        <div class="key-selector">
          <select id="root-note">
            <option value="C">C</option>
            <option value="Db">D♭</option>
            <option value="D">D</option>
            <option value="Eb">E♭</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="Gb">G♭</option>
            <option value="G">G</option>
            <option value="Ab">A♭</option>
            <option value="A">A</option>
            <option value="Bb">B♭</option>
            <option value="B">B</option>
          </select>
        </div>
        <button class="control-btn active" id="voice-leading-btn">
          Voice Leading: ON
        </button>
        <button class="control-btn" id="layout-toggle-btn">
          Layout: QWERTY
        </button>
      </div>

      <div class="display">
        <button id="start-audio">
          Start audio engine
          <span
            id="start-audio-subtext"
            style="font-size: 0.8em; opacity: 0.8; font-weight: normal"
            >(Press Enter)</span
          >
        </button>
        <div id="chord-info-container" style="display: none">
          <div class="chord-row">
            <h3 id="current-chord">—</h3>
            <button
              id="mobile-theremin-btn"
              aria-label="Activate Theremin Lead"
            ></button>
          </div>
          <div id="notes-display"></div>
        </div>
      </div>

      <!-- Default Interface (Horizontal Keys + Instructions) -->
      <div id="default-interface">
        <div class="keypad">
          <div class="key" data-note="1">
            <span class="key-label">1</span>
            <span class="mod-name">I</span>
          </div>
          <div class="key" data-note="2">
            <span class="key-label">2</span>
            <span class="mod-name">ii</span>
          </div>
          <div class="key" data-note="3">
            <span class="key-label">3</span>
            <span class="mod-name">iii</span>
          </div>
          <div class="key" data-note="4">
            <span class="key-label">4</span>
            <span class="mod-name">IV</span>
          </div>
          <div class="key" data-note="5">
            <span class="key-label">5</span>
            <span class="mod-name">V</span>
          </div>
          <div class="key" data-note="6">
            <span class="key-label">6</span>
            <span class="mod-name">vi</span>
          </div>
          <div class="key" data-note="7">
            <span class="key-label">7</span>
            <span class="mod-name">vii°</span>
          </div>
        </div>

        <div class="instructions">
          <h3>Chord modifiers (Hold + Chord)</h3>
          <div class="qwerty-container">
            <!-- Row 1 -->
            <div class="qwerty-row">
              <div
                class="mod-key btn-qual"
                id="mod-major"
                title="Major Triad (Q)"
              >
                <span class="key-label">Q</span>
                <span class="mod-name">Major</span>
              </div>
              <div
                class="mod-key btn-qual"
                id="mod-minor"
                title="Minor Triad (W)"
              >
                <span class="key-label">W</span>
                <span class="mod-name">Minor</span>
              </div>
              <div
                class="mod-key btn-qual"
                id="mod-dominant"
                title="Dominant 7th (E)"
              >
                <span class="key-label">E</span>
                <span class="mod-name">7</span>
              </div>
              <div
                class="mod-key btn-root"
                id="mod-rootShiftUp"
                title="Sharp Root (R)"
              >
                <span class="key-label">R</span>
                <span>♯</span>
              </div>
            </div>
            <!-- Row 2 -->
            <div class="qwerty-row stagger-1">
              <div
                class="mod-key btn-qual"
                id="mod-majorSeventh"
                title="Major 7th (A)"
              >
                <span class="key-label">A</span>
                <span class="mod-name">Maj 7</span>
              </div>
              <div
                class="mod-key btn-qual"
                id="mod-minorSeventh"
                title="Minor 7th (S)"
              >
                <span class="key-label">S</span>
                <span class="mod-name">Min 7</span>
              </div>
              <div
                class="mod-key btn-qual"
                id="mod-diminished"
                title="Diminished 7th (D)"
              >
                <span class="key-label">D</span>
                <span class="mod-name">Dim 7</span>
              </div>
              <div
                class="mod-key btn-root"
                id="mod-rootShiftDown"
                title="Flat Root (F)"
              >
                <span class="key-label">F</span>
                <span>♭</span>
              </div>
            </div>
            <!-- Row 3 -->
            <div class="qwerty-row stagger-2">
              <div
                class="mod-key btn-qual"
                id="mod-majorSixth"
                title="Major 6th (Z)"
              >
                <span class="key-label">Z</span>
                <span class="mod-name">Maj 6</span>
              </div>
              <div
                class="mod-key btn-qual"
                id="mod-minorSix"
                title="Minor 6th (X)"
              >
                <span class="key-label">X</span>
                <span class="mod-name">Min 6</span>
              </div>
              <div
                class="mod-key btn-qual"
                id="mod-halfDiminished"
                title="Half-Diminished (C)"
              >
                <span class="key-label">C</span>
                <span class="mod-name">ø</span>
              </div>
              <div
                class="mod-key btn-qual"
                id="mod-augmented"
                title="Augmented 7th (V)"
              >
                <span class="key-label">V</span>
                <span class="mod-name">Aug 7</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Alternate Numpad Interface (Hidden by Default) -->
      <div id="numpad-interface" style="display: none">
        <div class="numpad-grid">
          <!-- Row 1 -->
          <button
            class="np-btn btn-qual"
            id="np-halfDiminished"
            title="Half-Diminished (Clear)"
          >
            <span class="np-shortcut">clear/tab</span>
            Ø
          </button>
          <button
            class="np-btn btn-qual"
            id="np-dominant"
            title="Dominant 7th (/)"
          >
            <span class="np-shortcut">/</span>
            7
          </button>
          <button
            class="np-btn btn-qual"
            id="np-diminished"
            title="Diminished 7th (*)"
          >
            <span class="np-shortcut">*</span>
            Dim 7
          </button>
          <button class="np-btn btn-qual" id="np-minor" title="Minor Triad (-)">
            <span class="np-shortcut">-</span>
            Minor
          </button>

          <!-- Row 2 -->
          <button class="np-btn" id="np-key-7" data-note="7">
            <span class="np-shortcut">7</span>
            vii°
          </button>
          <button
            class="np-btn btn-qual"
            id="np-majorSixth"
            title="Major 6th (8)"
          >
            <span class="np-shortcut">8</span>
            6
          </button>
          <button
            class="np-btn btn-qual"
            id="np-majorSeventh"
            title="Major 7th (9)"
          >
            <span class="np-shortcut">9</span>
            Maj 7
          </button>
          <button
            class="np-btn btn-qual tall-y"
            id="np-augmented"
            title="Augmented (+)"
          >
            <span class="np-shortcut">+</span>
            Aug
          </button>

          <!-- Row 3 -->
          <button class="np-btn" id="np-key-4" data-note="4">
            <span class="np-shortcut">4</span>
            IV
          </button>
          <button class="np-btn" id="np-key-5" data-note="5">
            <span class="np-shortcut">5</span>
            V
          </button>
          <button class="np-btn" id="np-key-6" data-note="6">
            <span class="np-shortcut">6</span>
            vi
          </button>

          <!-- Row 4 -->
          <button class="np-btn" id="np-key-1" data-note="1">
            <span class="np-shortcut">1</span>
            I
          </button>
          <button class="np-btn" id="np-key-2" data-note="2">
            <span class="np-shortcut">2</span>
            ii
          </button>
          <button class="np-btn" id="np-key-3" data-note="3">
            <span class="np-shortcut">3</span>
            iii
          </button>
          <button
            class="np-btn btn-qual tall-y"
            id="np-major"
            title="Major Triad (Enter)"
          >
            <span class="np-shortcut">↵</span>
            Major
          </button>

          <!-- Row 5 -->
          <button
            class="np-btn btn-root wide-x"
            id="np-rootShiftDown"
            title="Root Flat (0)"
          >
            <span class="np-shortcut">0</span>
            ♭
          </button>
          <button
            class="np-btn btn-root"
            id="np-rootShiftUp"
            title="Root Sharp (.)"
          >
            <span class="np-shortcut">.</span>
            ♯
          </button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <button id="close-modal" aria-label="Close">&times;</button>
        <h2>How to play therochord</h2>
        <p>
          <strong>therochord</strong> turns your number keys and mouse into a
          unique chordal accompaniment / theremin-style lead instrument.
        </p>
        <ul>
          <li>
            <strong>Mouse theremin:</strong> Click anywhere on the screen to
            activate the theremin. Drag up and down to change pitch. If you are
            on a mobile device, you can press and hold the yellow button and
            move your phone up and down for the same effect. The root (green)
            and diatonic (white) notes are highlighted on the right vertical
            bar.
          </li>
          <li>
            <strong>Play Chords:</strong> Press <code>1-7</code> to play
            diatonic triad chords in the selected key. Hold to sustain the
            chord.
          </li>
          <li>
            <strong>Modify:</strong> Hold a modifier key (like
            <code>e</code> for Dominant 7th) while playing to change the chord
            quality.
          </li>
          <li>
            <strong>Transpose:</strong> Use the root ♯ and ♭ buttons to
            transpose the current chord.
          </li>
          <li>
            <strong>Voice Leading:</strong> Tries to move notes as little as
            possible between chords for a smooth sound. This can be toggled on
            and off.
          </li>
          <li>
            <strong>Change key:</strong> Use the dropdown to change key
            signatures, or hold <code>Enter</code> and press <code>+</code> or
            <code>-</code>
            to shift the key up or down a semitone.
          </li>
        </ul>

        <div class="modal-footer">
          <p>
            Note: the numerical keypad doesn't have minor 6 and minor 7 chord
            modifier buttons. You can alternatively access these chords by
            holding the
            <code>-</code> key along with the <code>/</code> key (minor 7) or
            <code>8</code> key (minor 6). If your numerical keypad has a
            delete/backspace key, this can also be used as a minor 7.
          </p>
        </div>
      </div>
    </div>

    <!-- Theremin UI -->
    <div id="theremin-container">
      <div id="theremin-bar">
        <div id="pitch-indicator"></div>
      </div>
    </div>

    <script type="module" src="app.js"></script>
  </body>
</html>
